<h1><%= file.title %></h1>
<h3><%= file.header %></h3>
<p>Owned by: <%= file.owner.displayName %></p>

<textarea id="file-body" rows="10" cols="80"><%= file.body %></textarea>
<p id="status" style="color: gray;"></p>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<script>
  const textarea = document.getElementById('file-body');
  const status = document.getElementById('status');
  const socket = io();
  const fileId = "<%= file._id %>";

  // Join file room
  socket.emit('join-file', fileId);

  // Emit changes on input
  textarea.addEventListener('input', () => {
    const newBody = textarea.value;
    socket.emit('edit-body', { fileId, newBody });
  });

  // Receive updates
  socket.on('body-updated', (newBody) => {
    textarea.value = newBody;
  });

  // Save to DB on blur
  textarea.addEventListener('blur', () => {
    const updatedBody = textarea.value;

    fetch(`/file/${fileId}/edit`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ body: updatedBody })
    })
    .then(res => {
      if (res.ok) {
        status.textContent = 'Saved!';
        setTimeout(() => status.textContent = '', 1000);
      } else {
        status.textContent = 'Error saving.';
      }
    })
    .catch(err => {
      console.error(err);
      status.textContent = 'Save failed.';
    });
  });
</script>
